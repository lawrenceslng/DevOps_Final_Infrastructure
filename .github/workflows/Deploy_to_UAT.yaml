name: Deploy to UAT

on:
  # schedule:
  #   - cron: '0 * * * *'  # optional: hourly check
  workflow_dispatch:

jobs:
  deploy-uat:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Infrastructure Repository
        uses: actions/checkout@v4
        with:
          path: Infra

      - name: Set ENV variables
        run: |
          echo "REPOS=frontend cart-service order-service product-service" >> $GITHUB_ENV
          echo "ORG=lawrenceslng" >> $GITHUB_ENV

      - name: Check for UAT tags
        id: check-tags
        run: |
          updated=false
          for repo in $REPOS; do
            latest_tag=$(curl -s https://api.github.com/repos/${ORG}/DevOps_Final_${repo^}/tags | jq -r '.[].name' | grep '^uat-' | head -n 1)
            if [[ $latest_tag != "" ]]; then
              echo "ðŸ“¦ UAT tag found in $repo: $latest_tag"
              updated=true
            fi
          done
          echo "changed=$updated" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_ACCOUNT_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}

      - name: Set up kubectl
        if: steps.check-tags.outputs.changed == 'true'
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Update kubeconfig
        if: steps.check-tags.outputs.changed == 'true'
        run: aws eks update-kubeconfig --region us-east-1 --name devops-final-cluster

      - name: Deploy to UAT namespace
        if: steps.check-tags.outputs.changed == 'true'
        run: |
          kubectl apply -f k8s/uat/namespace.yaml || true
          kubectl apply -f k8s/uat/env-config.yaml
          kubectl apply -f k8s/uat/deployment.yaml
          kubectl apply -f k8s/uat/services.yaml
          kubectl apply -f k8s/uat/ingress.yaml

